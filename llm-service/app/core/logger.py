"""
============================================================================
日志配置
使用 loguru 进行日志管理
============================================================================

文件位置：
  llm-service/app/core/logger.py

文件作用：
  配置全局日志系统，提供统一的日志记录功能

主要功能：
  1. 控制台日志输出 - 彩色格式化输出到终端
  2. 文件日志输出 - 记录到日志文件
  3. 日志轮转 - 自动切割和压缩日志文件
  4. 日志保留 - 自动清理过期日志

技术栈：
  - Loguru（现代化日志库）

日志级别：
  - DEBUG: 调试信息（最详细）
  - INFO: 一般信息
  - WARNING: 警告信息
  - ERROR: 错误信息
  - CRITICAL: 严重错误（最严重）

使用方式：
  from app.core.logger import logger
  logger.info("这是一条日志")
  logger.error("发生错误")

依赖文件：
  - app/core/config.py（配置管理）

============================================================================
"""
import sys  # 系统接口（用于获取标准输出）
from pathlib import Path  # 路径操作
from loguru import logger  # Loguru 日志库
from app.core.config import settings  # 应用配置

# ============================================================================
# 初始化：移除默认 Handler
# ============================================================================
# 移除 loguru 的默认 handler
# loguru 默认会输出到 stderr，这里移除后重新配置
logger.remove()

# ============================================================================
# Handler 1：控制台输出
# ============================================================================
# 添加控制台输出（彩色格式化）
logger.add(
    sys.stdout,  # 输出到标准输出（终端）
    # 日志格式（带颜色）：
    # <green>{time}</green>: 时间（绿色）
    # <level>{level}</level>: 日志级别（根据级别显示不同颜色）
    # <cyan>{name}:{function}:{line}</cyan>: 模块名:函数名:行号（青色）
    # <level>{message}</level>: 日志消息（根据级别显示不同颜色）
    format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
    level=settings.LOG_LEVEL,  # 日志级别（从配置读取，默认 INFO）
    colorize=True,  # 启用颜色（终端显示彩色日志）
)
# 输出示例：
# 2024-01-01 12:00:00 | INFO     | app.api.v1.generate:generate_stream:45 - 收到流式生成请求

# ============================================================================
# Handler 2：文件输出
# ============================================================================
# 添加文件输出（持久化存储）
logger.add(
    settings.LOG_FILE,  # 日志文件路径（从配置读取，默认 logs/llm-service.log）
    # 日志格式（纯文本，无颜色）：
    # {time}: 时间
    # {level}: 日志级别（左对齐，占 8 个字符）
    # {name}:{function}:{line}: 模块名:函数名:行号
    # {message}: 日志消息
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
    level=settings.LOG_LEVEL,  # 日志级别（从配置读取）
    rotation="500 MB",  # 日志轮转：文件大小达到 500MB 时自动切割
                        # 例如：llm-service.log -> llm-service.2024-01-01_12-00-00.log
    retention="10 days",  # 日志保留：只保留最近 10 天的日志，自动删除过期日志
    compression="zip",  # 日志压缩：切割后的日志文件自动压缩为 .zip 格式
                        # 例如：llm-service.2024-01-01_12-00-00.log.zip
    encoding="utf-8",  # 文件编码（支持中文）
)
# 文件示例：
# 2024-01-01 12:00:00 | INFO     | app.api.v1.generate:generate_stream:45 - 收到流式生成请求

# ============================================================================
# 导出配置
# ============================================================================
# 导出 logger 对象（供其他模块使用）
__all__ = ["logger"]

# ============================================================================
# 使用示例
# ============================================================================
# from app.core.logger import logger
#
# # 基本日志记录
# logger.debug("调试信息")
# logger.info("一般信息")
# logger.warning("警告信息")
# logger.error("错误信息")
# logger.critical("严重错误")
#
# # 带变量的日志
# user_id = 123
# logger.info(f"用户 {user_id} 登录成功")
#
# # 异常日志（自动记录堆栈）
# try:
#     1 / 0
# except Exception as e:
#     logger.exception("发生异常")  # 会自动记录完整的堆栈信息
#
# # 结构化日志（绑定上下文）
# logger.bind(request_id="abc123").info("处理请求")
# # 输出：... | request_id=abc123 | 处理请求

# ============================================================================
# 日志轮转说明
# ============================================================================
# rotation 参数支持的格式：
#   - "500 MB": 文件大小达到 500MB 时轮转
#   - "12:00": 每天 12:00 轮转
#   - "1 week": 每周轮转
#   - "1 day": 每天轮转
#
# retention 参数支持的格式：
#   - "10 days": 保留 10 天
#   - "1 week": 保留 1 周
#   - "1 month": 保留 1 个月
#   - 3: 保留 3 个文件
#
# compression 参数支持的格式：
#   - "zip": ZIP 压缩
#   - "gz": GZIP 压缩
#   - "bz2": BZIP2 压缩
#   - "xz": XZ 压缩

# ============================================================================
# Loguru 优势
# ============================================================================
# 相比标准库 logging 的优势：
#   1. 开箱即用，无需复杂配置
#   2. 自动捕获异常堆栈
#   3. 支持彩色输出
#   4. 支持日志轮转和压缩
#   5. 支持异步日志（高性能）
#   6. 支持结构化日志
#   7. API 简洁易用

# ============================================================================
# 日志文件结构
# ============================================================================
# logs/
#   ├── llm-service.log                    # 当前日志文件
#   ├── llm-service.2024-01-01_12-00-00.log.zip  # 已压缩的旧日志
#   ├── llm-service.2024-01-02_12-00-00.log.zip
#   └── ...
