"""
============================================================================
åšæŸ¥ AI æœç´¢å®¢æˆ·ç«¯
æ–‡æ¡£ï¼šhttps://bochaai.com/docs
============================================================================

æ–‡ä»¶ä½ç½®ï¼š
  llm-service/app/services/bocha_client.py

æ–‡ä»¶ä½œç”¨ï¼š
  å°è£…åšæŸ¥ AI æœç´¢ APIï¼Œæä¾›è”ç½‘æœç´¢åŠŸèƒ½

ä¸»è¦åŠŸèƒ½ï¼š
  1. è”ç½‘æœç´¢ - è°ƒç”¨åšæŸ¥ AI API æœç´¢äº’è”ç½‘å†…å®¹
  2. ç»“æœæ ‡å‡†åŒ– - å°† API è¿”å›çš„æ•°æ®è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
  3. é”™è¯¯å¤„ç† - å¤„ç†ç½‘ç»œé”™è¯¯ã€è¶…æ—¶ã€API é”™è¯¯ç­‰
  4. æ—¥å¿—è®°å½• - è®°å½•æœç´¢è¿‡ç¨‹å’Œç»“æœ

API æ–‡æ¡£ï¼š
  https://bochaai.com/docs

æŠ€æœ¯æ ˆï¼š
  - httpxï¼ˆå¼‚æ­¥ HTTP å®¢æˆ·ç«¯ï¼‰
  - loguruï¼ˆæ—¥å¿—è®°å½•ï¼‰

ä½¿ç”¨åœºæ™¯ï¼š
  - è”ç½‘æœç´¢ï¼ˆ/api/v1/searchï¼‰
  - RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰

ä¾èµ–æ–‡ä»¶ï¼š
  - app/core/config.pyï¼ˆé…ç½®ç®¡ç†ï¼‰
  - app/api/v1/search.pyï¼ˆæœç´¢æ¥å£ï¼‰

============================================================================
"""
import httpx  # å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ï¼ˆæ”¯æŒ HTTP/2ã€è¿æ¥æ± ç­‰ï¼‰
from typing import List, Dict, Any, Optional  # ç±»å‹æ³¨è§£
from loguru import logger  # æ—¥å¿—è®°å½•å™¨

#  ä¿®æ”¹ï¼šç›´æ¥å¯¼å…¥ settings å®ä¾‹ï¼Œè€Œä¸æ˜¯ get_settings å‡½æ•°
from app.core.config import settings  # åº”ç”¨é…ç½®


# ============================================================================
# åšæŸ¥æœç´¢å®¢æˆ·ç«¯ç±»
# ============================================================================

class BochaSearchClient:
    """
    åšæŸ¥æœç´¢å®¢æˆ·ç«¯
    
    åŠŸèƒ½è¯´æ˜ï¼š
      - å°è£…åšæŸ¥ AI æœç´¢ API
      - æä¾›ç®€æ´çš„æœç´¢æ¥å£
      - è‡ªåŠ¨å¤„ç†è®¤è¯ã€é”™è¯¯ã€é‡è¯•ç­‰
    
    ä½¿ç”¨ç¤ºä¾‹ï¼š
        client = BochaSearchClient()
        result = await client.search("Python æ•™ç¨‹")
        print(result["results"])
    """

    def __init__(self):
        """
        åˆå§‹åŒ–å®¢æˆ·ç«¯
        
        ä»é…ç½®ä¸­è¯»å– API å‚æ•°ï¼š
          - api_url: API åœ°å€
          - api_key: API å¯†é’¥
          - max_results: é»˜è®¤è¿”å›ç»“æœæ•°
          - timeout: è¯·æ±‚è¶…æ—¶æ—¶é—´
        """
        self.api_url = settings.BOCHA_API_URL  # API åœ°å€ï¼ˆé»˜è®¤ï¼šhttps://api.bochaai.com/v1/web-searchï¼‰
        self.api_key = settings.BOCHA_API_KEY  # API å¯†é’¥ï¼ˆä» .env è¯»å–ï¼‰
        self.max_results = settings.BOCHA_MAX_RESULTS  # é»˜è®¤è¿”å›ç»“æœæ•°ï¼ˆé»˜è®¤ï¼š10ï¼‰
        self.timeout = settings.BOCHA_TIMEOUT  # è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ï¼š30 ç§’ï¼‰

    async def search(
            self,
            query: str,  # æœç´¢å…³é”®è¯ï¼ˆå¿…å¡«ï¼‰
            count: Optional[int] = None,  # è¿”å›ç»“æœæ•°é‡ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨é…ç½®å€¼ï¼‰
            freshness: str = "noLimit",  # æ—¶é—´èŒƒå›´ï¼ˆnoLimit/day/week/monthï¼‰
            summary: bool = False  # æ˜¯å¦è¿”å›æ‘˜è¦ï¼ˆé»˜è®¤ Falseï¼‰
    ) -> Dict[str, Any]:
        """
        æ‰§è¡Œæœç´¢
        
        åŠŸèƒ½è¯´æ˜ï¼š
          - è°ƒç”¨åšæŸ¥ AI API æœç´¢äº’è”ç½‘å†…å®¹
          - è‡ªåŠ¨å¤„ç†è®¤è¯ã€é”™è¯¯ã€è¶…æ—¶ç­‰
          - æ ‡å‡†åŒ–è¿”å›æ•°æ®æ ¼å¼
        
        Args:
            query: æœç´¢å…³é”®è¯ï¼ˆå¿…å¡«ï¼‰
                ç¤ºä¾‹ï¼š"Python æ•™ç¨‹"ã€"2024å¹´AIæœ€æ–°è¿›å±•"
            
            count: è¿”å›ç»“æœæ•°é‡ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨é…ç½®å€¼ï¼‰
                èŒƒå›´ï¼š1-20
                ç¤ºä¾‹ï¼š10
            
            freshness: æ—¶é—´èŒƒå›´ï¼ˆå¯é€‰ï¼Œé»˜è®¤ "noLimit"ï¼‰
                å¯é€‰å€¼ï¼š
                  - "noLimit": ä¸é™åˆ¶æ—¶é—´ï¼ˆé»˜è®¤ï¼‰
                  - "day": æœ€è¿‘ä¸€å¤©
                  - "week": æœ€è¿‘ä¸€å‘¨
                  - "month": æœ€è¿‘ä¸€ä¸ªæœˆ
            
            summary: æ˜¯å¦è¿”å›æ‘˜è¦ï¼ˆå¯é€‰ï¼Œé»˜è®¤ Falseï¼‰
                - True: è¿”å› AI ç”Ÿæˆçš„æœç´¢æ‘˜è¦
                - False: åªè¿”å›æœç´¢ç»“æœåˆ—è¡¨

        Returns:
            æ ‡å‡†åŒ–çš„æœç´¢ç»“æœå­—å…¸ï¼š
            {
                "results": [  # æœç´¢ç»“æœåˆ—è¡¨
                    {
                        "title": "æ ‡é¢˜",  # ç½‘é¡µæ ‡é¢˜
                        "url": "é“¾æ¥",  # ç½‘é¡µ URL
                        "content": "æ‘˜è¦",  # å†…å®¹æ‘˜è¦
                        "publishedDate": "å‘å¸ƒæ—¶é—´",  # å‘å¸ƒæ—¥æœŸï¼ˆå¯é€‰ï¼‰
                        "siteName": "ç½‘ç«™åç§°",  # ç½‘ç«™åç§°ï¼ˆå¯é€‰ï¼‰
                        "siteIcon": "ç½‘ç«™å›¾æ ‡"  # ç½‘ç«™å›¾æ ‡ URLï¼ˆå¯é€‰ï¼‰
                    }
                ],
                "total": 10  # ç»“æœæ€»æ•°
            }

        Raises:
            ValueError: API Key æœªé…ç½®
            Exception: æœç´¢å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ã€API é”™è¯¯ã€è¶…æ—¶ç­‰ï¼‰
        
        ä½¿ç”¨ç¤ºä¾‹ï¼š
            # åŸºæœ¬æœç´¢
            result = await client.search("Python æ•™ç¨‹")
            
            # é™åˆ¶ç»“æœæ•°é‡
            result = await client.search("Python æ•™ç¨‹", count=5)
            
            # æœç´¢æœ€è¿‘ä¸€å‘¨çš„å†…å®¹
            result = await client.search("AI æ–°é—»", freshness="week")
        """
        # ========== 1. å‚æ•°éªŒè¯ ==========
        # æ£€æŸ¥ API Key æ˜¯å¦é…ç½®
        if not self.api_key:
            raise ValueError("åšæŸ¥ API Key æœªé…ç½®ï¼Œè¯·åœ¨ .env ä¸­è®¾ç½® BOCHA_API_KEY")

        # å¦‚æœæœªæŒ‡å®šç»“æœæ•°é‡ï¼Œä½¿ç”¨é…ç½®çš„é»˜è®¤å€¼
        if count is None:
            count = self.max_results

        try:
            # ========== 2. å‘é€è¯·æ±‚ ==========
            logger.info(f"ğŸ” åšæŸ¥æœç´¢: {query}")  # è®°å½•æœç´¢å…³é”®è¯

            # ä½¿ç”¨ httpx å¼‚æ­¥å®¢æˆ·ç«¯å‘é€ POST è¯·æ±‚
            async with httpx.AsyncClient(timeout=self.timeout) as client:
                response = await client.post(
                    self.api_url,  # API åœ°å€
                    headers={
                        "Content-Type": "application/json",  # è¯·æ±‚ä½“æ ¼å¼
                        "Authorization": f"Bearer {self.api_key}"  # è®¤è¯å¤´ï¼ˆBearer Tokenï¼‰
                    },
                    json={  # è¯·æ±‚ä½“ï¼ˆJSON æ ¼å¼ï¼‰
                        "query": query,  # æœç´¢å…³é”®è¯
                        "freshness": freshness,  # æ—¶é—´èŒƒå›´
                        "summary": summary,  # æ˜¯å¦è¿”å›æ‘˜è¦
                        "count": count  # è¿”å›ç»“æœæ•°é‡
                    }
                )

            # ========== 3. æ£€æŸ¥ HTTP çŠ¶æ€ç  ==========
            # å¦‚æœ HTTP çŠ¶æ€ç ä¸æ˜¯ 200ï¼Œè¯´æ˜è¯·æ±‚å¤±è´¥
            if response.status_code != 200:
                error_text = response.text  # è·å–é”™è¯¯ä¿¡æ¯
                raise Exception(
                    f"åšæŸ¥ API HTTP é”™è¯¯: {response.status_code} {error_text}"
                )

            # ========== 4. è§£æå“åº” ==========
            # å°†å“åº”ä½“è§£æä¸º JSON
            data = response.json()

            logger.debug(f"åšæŸ¥ API åŸå§‹è¿”å›: {data}")  # è®°å½•åŸå§‹å“åº”ï¼ˆè°ƒè¯•ç”¨ï¼‰

            # ========== 5. æ£€æŸ¥ä¸šåŠ¡çŠ¶æ€ç  ==========
            # åšæŸ¥ API è¿”å›æ ¼å¼ï¼š{"code": 200, "msg": "success", "data": {...}}
            # å¦‚æœ code ä¸æ˜¯ 200ï¼Œè¯´æ˜ä¸šåŠ¡é€»è¾‘é”™è¯¯
            if data.get("code") != 200:
                raise Exception(
                    f"åšæŸ¥ API è¿”å›é”™è¯¯: code={data.get('code')}, "
                    f"msg={data.get('msg', 'æœªçŸ¥é”™è¯¯')}"
                )

            # ========== 6. æå–æœç´¢ç»“æœ ==========
            # ä»å“åº”ä¸­æå–æœç´¢ç»“æœåˆ—è¡¨
            # æ•°æ®ç»“æ„ï¼šdata.data.webPages.value
            web_pages = data.get("data", {}).get("webPages", {}).get("value", [])

            # å¦‚æœæ²¡æœ‰æœç´¢ç»“æœï¼Œè¿”å›ç©ºç»“æœ
            if not web_pages:
                logger.warning(" åšæŸ¥æœç´¢æœªè¿”å›ç»“æœ")
                return {
                    "results": [],
                    "total": 0,
                    "message": "æœªæ‰¾åˆ°ç›¸å…³ç»“æœ"
                }

            logger.info(f" åšæŸ¥è¿”å› {len(web_pages)} ä¸ªç»“æœ")  # è®°å½•ç»“æœæ•°é‡

            # ========== 7. æ ‡å‡†åŒ–æ•°æ®æ ¼å¼ ==========
            # å°†åšæŸ¥ API çš„æ•°æ®æ ¼å¼è½¬æ¢ä¸ºç»Ÿä¸€çš„æ ‡å‡†æ ¼å¼
            results = []
            for item in web_pages:
                results.append({
                    "title": item.get("name", "æœªå‘½åæ¥æº"),  # æ ‡é¢˜ï¼ˆé»˜è®¤å€¼ï¼šæœªå‘½åæ¥æºï¼‰
                    "url": item.get("url", "#"),  # URLï¼ˆé»˜è®¤å€¼ï¼š#ï¼‰
                    "content": item.get("snippet", ""),  # å†…å®¹æ‘˜è¦ï¼ˆé»˜è®¤å€¼ï¼šç©ºå­—ç¬¦ä¸²ï¼‰
                    "publishedDate": item.get("datePublished") or item.get("dateLastCrawled"),  # å‘å¸ƒæ—¥æœŸï¼ˆä¼˜å…ˆä½¿ç”¨ datePublishedï¼‰
                    "siteName": item.get("siteName", ""),  # ç½‘ç«™åç§°ï¼ˆé»˜è®¤å€¼ï¼šç©ºå­—ç¬¦ä¸²ï¼‰
                    "siteIcon": item.get("siteIcon", "")  # ç½‘ç«™å›¾æ ‡ï¼ˆé»˜è®¤å€¼ï¼šç©ºå­—ç¬¦ä¸²ï¼‰
                })

            # ========== 8. è¿”å›ç»“æœ ==========
            return {
                "results": results,  # æœç´¢ç»“æœåˆ—è¡¨
                "total": len(results)  # ç»“æœæ€»æ•°
            }

        # ========== 9. å¼‚å¸¸å¤„ç† ==========
        except httpx.TimeoutException:
            # è¶…æ—¶å¼‚å¸¸ï¼ˆè¯·æ±‚è¶…è¿‡ timeout è®¾ç½®çš„æ—¶é—´ï¼‰
            logger.error(" åšæŸ¥æœç´¢è¶…æ—¶")
            raise Exception("æœç´¢è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•")
        
        except httpx.RequestError as e:
            # ç½‘ç»œé”™è¯¯ï¼ˆè¿æ¥å¤±è´¥ã€DNS è§£æå¤±è´¥ç­‰ï¼‰
            logger.error(f" åšæŸ¥æœç´¢ç½‘ç»œé”™è¯¯: {e}")
            raise Exception(f"ç½‘ç»œé”™è¯¯: {str(e)}")
        
        except Exception as e:
            # å…¶ä»–å¼‚å¸¸ï¼ˆè§£æé”™è¯¯ã€ä¸šåŠ¡é”™è¯¯ç­‰ï¼‰
            logger.error(f" åšæŸ¥æœç´¢å¤±è´¥: {e}")
            raise


# ============================================================================
# å…¨å±€å®ä¾‹
# ============================================================================
# åˆ›å»ºå…¨å±€å®¢æˆ·ç«¯å®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
# åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œé¿å…é‡å¤åˆå§‹åŒ–
bocha_client = BochaSearchClient()


# ============================================================================
# ä½¿ç”¨ç¤ºä¾‹
# ============================================================================
# from app.services.bocha_client import bocha_client
#
# # åŸºæœ¬æœç´¢
# result = await bocha_client.search("Python æ•™ç¨‹")
# print(result["results"])
#
# # é™åˆ¶ç»“æœæ•°é‡
# result = await bocha_client.search("Python æ•™ç¨‹", count=5)
#
# # æœç´¢æœ€è¿‘ä¸€å‘¨çš„å†…å®¹
# result = await bocha_client.search("AI æ–°é—»", freshness="week")
#
# # è¿”å› AI æ‘˜è¦
# result = await bocha_client.search("AI æ–°é—»", summary=True)

# ============================================================================
# åšæŸ¥ API å“åº”æ ¼å¼
# ============================================================================
# {
#     "code": 200,
#     "msg": "success",
#     "data": {
#         "webPages": {
#             "value": [
#                 {
#                     "name": "Python æ•™ç¨‹ - èœé¸Ÿæ•™ç¨‹",
#                     "url": "https://www.runoob.com/python/python-tutorial.html",
#                     "snippet": "Python æ˜¯ä¸€ç§è§£é‡Šå‹ã€é¢å‘å¯¹è±¡ã€åŠ¨æ€æ•°æ®ç±»å‹çš„é«˜çº§ç¨‹åºè®¾è®¡è¯­è¨€...",
#                     "datePublished": "2024-01-01T00:00:00Z",
#                     "dateLastCrawled": "2024-01-15T00:00:00Z",
#                     "siteName": "èœé¸Ÿæ•™ç¨‹",
#                     "siteIcon": "https://www.runoob.com/favicon.ico"
#                 }
#             ]
#         }
#     }
# }

# ============================================================================
# é”™è¯¯å¤„ç†è¯´æ˜
# ============================================================================
# 1. API Key æœªé…ç½®
#    é”™è¯¯ï¼šValueError("åšæŸ¥ API Key æœªé…ç½®...")
#    è§£å†³ï¼šåœ¨ .env ä¸­è®¾ç½® BOCHA_API_KEY
#
# 2. HTTP é”™è¯¯ï¼ˆçŠ¶æ€ç é 200ï¼‰
#    é”™è¯¯ï¼šException("åšæŸ¥ API HTTP é”™è¯¯: 401 Unauthorized")
#    è§£å†³ï¼šæ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®
#
# 3. ä¸šåŠ¡é”™è¯¯ï¼ˆcode é 200ï¼‰
#    é”™è¯¯ï¼šException("åšæŸ¥ API è¿”å›é”™è¯¯: code=400, msg=å‚æ•°é”™è¯¯")
#    è§£å†³ï¼šæ£€æŸ¥è¯·æ±‚å‚æ•°æ˜¯å¦æ­£ç¡®
#
# 4. è¶…æ—¶é”™è¯¯
#    é”™è¯¯ï¼šException("æœç´¢è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•")
#    è§£å†³ï¼šå¢åŠ  BOCHA_TIMEOUT é…ç½®å€¼
#
# 5. ç½‘ç»œé”™è¯¯
#    é”™è¯¯ï¼šException("ç½‘ç»œé”™è¯¯: Connection refused")
#    è§£å†³ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ API åœ°å€

# ============================================================================
# æ€§èƒ½ä¼˜åŒ–å»ºè®®
# ============================================================================
# 1. è¿æ¥æ± ï¼šhttpx é»˜è®¤ä½¿ç”¨è¿æ¥æ± ï¼Œæ— éœ€é¢å¤–é…ç½®
# 2. è¶…æ—¶è®¾ç½®ï¼šæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ BOCHA_TIMEOUT
# 3. ç»“æœç¼“å­˜ï¼šå¯ä»¥æ·»åŠ  Redis ç¼“å­˜æœç´¢ç»“æœ
# 4. é‡è¯•æœºåˆ¶ï¼šå¯ä»¥æ·»åŠ è‡ªåŠ¨é‡è¯•é€»è¾‘ï¼ˆå¦‚ tenacity åº“ï¼‰
